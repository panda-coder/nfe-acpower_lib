<?php	//require_once('core_cte.php');		class CTeSyslog_xml{			public $id_ctesyslog;		public $natureza_operacao;		public $numero_nota;		public $chave_nota;		public $numero_cte;		public $serie_nota;		public $cnpj_emitente;		public $emitente;		public $cnpj_remetente;		public $remetente;		public $cnpj_expedidor;		public $expedidor;		public $cnpj_recebedor;		public $recebedor;		public $cnpj_destinatario;		public $destinatario;		public $chave_cte;		public $situacao;		public $dacte_criada;		public $data_dacte;		public $data_email;		public $data_emissao;		public $tipo_ambiente;		public $protocolo;				public $id_db;		public $domxml;		public $xml_str;		public $DbConnection;			function __construct($db, $xml){			$this->domxml = new DOMDocument(); 			$this->domxml->loadXML($xml);			$this->xml_str = $xml;						$this->DbConnection = $db;						if($this->domxml->getElementsByTagName("infCte")->item(0)->getAttribute('versao')=="2.00") {											if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->length>0) {				$this->natureza_operacao	= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->item(0)->getElementsByTagName("natOp")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("infCTeNorm")->length>0) {				$this->chave_nota			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("infCTeNorm")->item(0)->getElementsByTagName("infDoc")->item(0)->getElementsByTagName("infNFe")->item(0)->getElementsByTagName("chave")->item(0)->nodeValue;				$this->numero_nota = intval(substr($this->chave_nota,25,9));				}												if ($this->domxml->getElementsByTagName("infCte")->length>0) {				$this->serie_nota			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("serie")->item(0)->nodeValue;				}								if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("emit")->length>0) {				$this->cnpj_emitente		= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("emit")->item(0)->getElementsByTagName("CNPJ")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("emit")->length>0) {				$this->emitente				= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("emit")->item(0)->getElementsByTagName("xNome")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("rem")->length>0) {				$this->cnpj_remetente		= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("rem")->item(0)->getElementsByTagName("CNPJ")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("rem")->length>0) {				$this->remetente			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("rem")->item(0)->getElementsByTagName("xNome")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("exped")->length>0) {				$this->cnpj_expedidor		= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("exped")->item(0)->getElementsByTagName("CNPJ")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("exped")->length>0) {				$this->expedidor			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("exped")->item(0)->getElementsByTagName("xNome")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("receb")->length>0) {				$this->cnpj_recebedor		= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("receb")->item(0)->getElementsByTagName("CNPJ")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("receb")->length>0) {				$this->recebedor			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("receb")->item(0)->getElementsByTagName("xNome")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("dest")->length>0) {				$this->cnpj_destinatario	= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("dest")->item(0)->getElementsByTagName("CNPJ")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("dest")->length>0) {				$this->destinatario			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("dest")->item(0)->getElementsByTagName("xNome")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->length>0) {				$this->chave_cte			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->item(0)->getElementsByTagName("refCTE")->item(0)->nodeValue;				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->length>0) {				$this->data_emissao			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->item(0)->getElementsByTagName("dhEmi")->item(0)->nodeValue;				$this->data_emissao 		= str_replace("T"," ",$this->data_emissao);				}				if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->length>0) {				$this->tipo_ambiente		= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->item(0)->getElementsByTagName("tpAmb")->item(0)->nodeValue;				}																if ($this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->length>0) {				$this->numero_cte			= $this->domxml->getElementsByTagName("infCte")->item(0)->getElementsByTagName("ide")->item(0)->getElementsByTagName("nCT")->item(0)->nodeValue;				}			} else {				die();			}					}				public function getChave() {			return $this->chave_cte;		}				public function getXML(){			return $this->xml_str;		}				public function getNumeroNota(){			return $this->numero_nota;		}				public function getEmitente(){			return $this->domxml->getElementsByTagName("emit")->item(0)->getElementsByTagName("xNome")->item(0)->nodeValue;		}				public function getTomador(){			return $this->domxml->getElementsByTagName("rem")->item(0)->getElementsByTagName("xNome")->item(0)->nodeValue;		}				public function getCNPJEmit() {			return $this->domxml->getElementsByTagName("emit")->item(0)->getElementsByTagName("CNPJ")->item(0)->nodeValue;		}				public function getCNPJTomador(){			return $this->domxml->getElementsByTagName("rem")->item(0)->getElementsByTagName("CNPJ")->item(0)->nodeValue;		}				public function getProtocol(){			$prot = $this->domxml->getElementsByTagName("infProt");			if ( $prot->length > 0) {				$this->protocolo = $prot->item(0)->getElementsByTagName("nProt")->item(0)->nodeValue;				return $this->protocolo;			}			return false;		}				public function getSit(){			$dataset = $this->DbConnection->lookup("SELECT situacao FROM t_ctesyslog WHERE chave_cte='" . $this->getChave() . "'");			if (!empty($dataset)) {				list($sit) = $dataset[0];					return $sit;			} else {				return NULL;			}		}				public function getBdId(){			$dataset = $this->DbConnection->lookup("SELECT id_ctesyslog FROM t_ctesyslog WHERE chave_cte='" . $this->getChave() . "'");			if ( !empty($dataset) ){				list($id) = $dataset[0];				return $id;			} else {				return NULL;			}		}				public function SaveCTE(){			$dataset = $this->DbConnection->lookup("SELECT COUNT(*) FROM t_ctesyslog WHERE chave_cte='" . $this->getChave() . "'");						list($qt) = $dataset[0];						if ( $qt == "0" ){				$this->InsertBd();				return TRUE;			}			return FALSE;		}				private function incAndamento($num){			if (!empty($num)){				if ($this->id_db = $this->getBdId()) {					$this->DbConnection->exec("INSERT INTO t_andamento_ctesyslog(id_ctesyslog, andamento_ctesyslog, data_hora) VALUES($this->id_db, '" . $this->getAndamentoCodeNum($num) . "', CURRENT_TIMESTAMP)");				}			}		}						private function InsertBd(){			$sql = "INSERT INTO t_ctesyslog(natureza_operacao, numero_nota, serie_nota, cnpj_emitente, emitente,			cnpj_remetente, remetente, cnpj_expedidor, expedidor, cnpj_recebedor, recebedor, cnpj_destinatario,			destinatario, chave_cte, data_emissao, tipo_ambiente, situacao, numero_cte) VALUES (				'$this->natureza_operacao', '$this->numero_nota','$this->serie_nota','$this->cnpj_emitente',				'$this->emitente','$this->cnpj_remetente','$this->remetente','$this->cnpj_expedidor','$this->expedidor',				'$this->cnpj_recebedor','$this->recebedor','$this->cnpj_destinatario','$this->destinatario','$this->chave_cte',				DATE_FORMAT('$this->data_emissao','%Y-%m-%d %T'),'$this->tipo_ambiente', 'I','$this->numero_cte')";			$this->DbConnection->exec($sql);						$this->id_db = $this->DbConnection->lastInsertId();						$ins_xml = $this->xml_str;						$this->DbConnection->exec("INSERT INTO t_xml_ctesyslog(id_ctesyslog, xml) VALUES($this->id_db, '".addslashes($ins_xml)."')");						//Envia para o andamento de inclusÃ£o			$this->incAndamento(1);		}						public function saveValidade(){			$this->incAndamento(2);			$this->DbConnection->exec("update t_ctesyslog set situacao='V' where id_ctesyslog=$this->id_db");		}				public function newXML($xml){			if ( !empty($xml) ){				if ( empty($this->id_db) ){					$this->id_db = $this->getBdId();				}				if (!empty($this->id_db)) {					$this->DbConnection->exec("DELETE FROM t_xml_ctesyslog WHERE id_ctesyslog=$this->id_db");					$this->DbConnection->exec("INSERT INTO t_xml_ctesyslog(id_ctesyslog, xml) VALUES($this->id_db, '".addslashes($xml)."')");				}			}		}				public function saveLog($log){			if ($this->id_db = $this->getBdId()) {				$this->DbConnection->exec("INSERT INTO t_andamento_ctesyslog(id_ctesyslog, andamento_ctesyslog, data_hora) VALUES($this->id_db, '" . utf8_decode($log) . "', CURRENT_TIMESTAMP)");			}		}				public function saveEnvio(){			$this->incAndamento(4);			$this->DbConnection->exec("update t_ctesyslog set situacao='P' where id_ctesyslog=$this->id_db");		}				public function saveAprovada(){			$this->incAndamento(5);						//Update no campo de SituaÃ§Ã£o			$this->DbConnection->exec("update t_ctesyslog set situacao='A' where id_ctesyslog=$this->id_db");		}				public function saveCancelada(){			$this->incAndamento(10);						//Update no campo de SituaÃ§Ã£o			$this->DbConnection->exec("update t_ctesyslog set situacao='C' where id_ctesyslog=$this->id_db");		}				public function saveReprovada($motivo = ""){					$this->incAndamento(6);						if ( !empty($motivo) ){				$this->DbConnection->exec("INSERT INTO t_andamento_ctesyslog(id_ctesyslog, andamento_ctesyslog, data_hora) VALUES($this->id_db, 'REJEICAO: " . utf8_decode($motivo) . "', CURRENT_TIMESTAMP)");			}						$this->DbConnection->exec("update t_ctesyslog set situacao='R' where id_ctesyslog=$this->id_db and situacao<>'A'");					}				public function saveDenegada(){			$this->incAndamento(7);			$this->DbConnection->exec("update t_ctesyslog set situacao='D' where id_ctesyslog=$this->id_db");		}				public function saveEnvioEmail(){			$this->incAndamento(9);			$this->DbConnection->exec("update t_ctesyslog set data_email=ifnull(data_email, current_date) where id_ctesyslog=$this->id_db");		}						public function savePrinting(){			$this->incAndamento(8);			//Colocar update do campo impresso			$this->DbConnection->exec("update t_ctesyslog set data_dacte=CURRENT_TIMESTAMP where id_ctesyslog=$this->id_db");		}						public function saveErrorValidade($motivo = ""){			$this->incAndamento(3);			if ( !empty($motivo) ){				$motivo = str_replace("'", "-",$motivo);						$this->DbConnection->exec("INSERT INTO t_andamento_ctesyslog(id_ctesyslog, andamento_ctesyslog, data_hora) VALUES($this->id_db, 'REJEICAO: " . utf8_decode(substr($motivo,0,185)) . "', CURRENT_TIMESTAMP)");			}		}				public function voltaRejeicao() {			$this->DbConnection->exec("update t_ctesyslog set situacao='I' where id_ctesyslog=$this->id_db");		}				public function WriteProtocol(){				/*			try {				echo "antes";				$prot = $this->domxml->getElementsByTagName("infProt");				if ( $prot->length > 0) {					$this->protocolo = $prot->item(0)->getElementsByTagName("nProt")->item(0)->nodeValue;				}				$prot = 				echo "depois";			} catch(Exception $e) {				echo $e->getMessage();			}			*/			if ($this->getProtocol()) {				if ($this->id_db = $this->getBdId()) {					$this->DbConnection->exec("update t_ctesyslog set protocolo='$this->protocolo' where id_ctesyslog=$this->id_db");				}			}		}						private function getAndamentoCodeNum($code){			$str = "";					switch($code){				case "1":					$str = 'CTE INCLUIDO';					break;				case "2":					$str = 'CTE VALIDADO';					break;				case "3":					$str = 'FALHA DE ESQUEMA';					break;				case "4":					$str = 'ENVIADO PARA SEFAZ';					break;				case "5":					$str = 'CTE APROVADO';					break;				case "6":					$str = 'CTE REJEITADO';					break;				case "7":					$str = 'CTE DENEGADO';					break;				case "8":					$str = 'DACTE IMPRESSO';					break;				case "9":					$str = 'EMAIL ENVIADO';					break;				case "10":					$str = 'CTE CANCELADO';					break;				default:					$str = 'DESCONHECIDO';					break;			}			return $str;		}	}		class CteSyslog_x_bd extends CteSyslog_xml{			function __construct($db, $id){								$this->DbConnection = $db;						//var_dump($this->DbConnection);									try{				$dataset = $this->DbConnection->lookup("select xml from t_xml_ctesyslog where id_ctesyslog=$id");				list($xml) = $dataset[0];			}catch(Exception $e){				echo "erro " . $e->getMessage();			}						if($xml!='') {				parent::__construct($this->DbConnection, $xml);			}					}					}?>